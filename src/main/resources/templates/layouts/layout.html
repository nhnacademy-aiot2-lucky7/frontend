<!-- layout.html -->
<!DOCTYPE html>
<html lang="ko" xmlns="http://www.w3.org/1999/xhtml"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport"/>
    <link href="/img/icons/777_64x64.png" rel="shortcut icon"/>
    <title>Lucky Seven</title>

    <link href="/css/common.css" rel="stylesheet"/>

    <script th:inline="javascript">
        /*<![CDATA[*/
        window.currentUser = /*[[${user} != null ? ${user} : null]]*/ null;
        /*]]>*/
    </script>

    <script defer src="/js/bootstrap.bundle.min.js"></script>
    <script defer src="/js/feather.min.js"></script>
    <script defer src="/js/feather-replace.js"></script>
    <script defer src="/js/admin-check.js"></script>
    <script defer src="/js/common.js"></script>
    <script defer src="/js/dashboard/dashboard-manager.js"></script>
    <script defer src="/js/auth-check.js"></script>
</head>
<body>
<div class="wrapper d-flex">
    <!-- 관리자 사이드바 -->
    <th:block th:if="${user != null and #strings.trim(user.userRole).toUpperCase() == 'ROLE_ADMIN'}">
        <div th:replace="~{fragments/sidebar_adm :: sidebar_admin}"></div>
    </th:block>
    <!-- 일반 유저 사이드바 -->
    <th:block th:if="${user != null and #strings.trim(user.userRole).toUpperCase() != 'ROLE_ADMIN'}">
        <div th:replace="~{fragments/sidebar :: sidebar_user}"></div>
    </th:block>
    <!-- 게스트 사이드바 -->
    <th:block th:if="${user == null}">
        <div th:replace="~{fragments/sidebar_guest :: sidebar_guest}"></div>
    </th:block>

    <main class="main flex-grow-1">
        <header th:replace="~{fragments/navbar :: navbar}"></header>
        <section class="content" layout:fragment="content"></section>
        <footer th:replace="~{fragments/footer :: footer}"></footer>
    </main>
</div>

<script>
    async function fetchUnreadCount() {
        try {
            const response = await fetch('http://localhost:10232/notifications/unread-count', {
                method: 'GET',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' }
            });
            if (!response.ok) {
                console.error('서버 응답 에러:', response.status, response.statusText);
                throw new Error('알림 개수 불러오기 실패');
            }
            const count = await response.json();
            return count;
        } catch (error) {
            console.error('알림 개수 요청 중 오류 발생:', error);
            return 0;
        }
    }

    async function fetchNotifications() {
        try {
            const response = await fetch('http://localhost:10232/notifications/unread?size=5', {
                method: 'GET',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' }
            });
            if (!response.ok) {
                console.error('서버 응답 에러:', response.status, response.statusText);
                throw new Error('알림 불러오기 실패');
            }
            const data = await response.json();
            return data;
        } catch (error) {
            console.error('알림 요청 중 오류 발생:', error);
            return null;
        }
    }

    function renderNotifications(data) {
        const listGroup = document.querySelector('.list-group');
        const header = document.querySelector('.dropdown-menu-header');

        if (!data || !data.content || data.content.length === 0) {
            header.textContent = '알림 없음';
            listGroup.innerHTML = `
                <div class="list-group-item">
                    <div class="row g-0 align-items-center">
                        <div class="col-12 text-muted">
                            <p class="mb-0">새로운 알림이 없습니다</p>
                        </div>
                    </div>
                </div>`;
            return;
        }

        header.textContent = `${data.content.length}개의 알림`;

        const itemsHtml = data.content.map(event => {
            let icon = '';
            if (event.eventLevel === 'ERROR') icon = `<i class="text-danger" data-feather="alert-circle"></i>`;
            else if (event.eventLevel === 'WARN') icon = `<i class="text-warning" data-feather="alert-triangle"></i>`;
            else if (event.eventLevel === 'INFO') icon = `<i class="text-info" data-feather="info"></i>`;

            const formattedDate = new Date(event.eventAt).toLocaleString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });

            return `
                <a class="list-group-item" href="/event">
                    <div class="row g-0 align-items-center">
                        <div class="col-2">${icon}</div>
                        <div class="col-10">
                            <div class="text-dark">${event.eventSource.sourceId}</div>
                            <div class="text-muted small mt-1">${event.eventDetails}</div>
                            <div class="text-muted small mt-1">${formattedDate}</div>
                        </div>
                    </div>
                </a>`;
        }).join('');

        listGroup.innerHTML = itemsHtml;

        if (window.feather) {
            window.feather.replace();
        }
    }

    async function updateNotificationUI() {
        const [count, data] = await Promise.all([
            fetchUnreadCount(),
            fetchNotifications()
        ]);

        const indicator = document.querySelector('.indicator');
        if (indicator) {
            indicator.textContent = count;
        }

        renderNotifications(data);
    }

    document.addEventListener('DOMContentLoaded', updateNotificationUI);
</script>

</body>
</html>
